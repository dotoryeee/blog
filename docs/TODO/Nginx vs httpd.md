# Nginx vs Apache httpd

!!! warning
    인터넷에서 정보 수집 중입니다. 틀린 정보도 많아서 팩트체크 진행중입니다.

- Youtube [10분 테코톡 피케이의 Nginx](https://www.youtube.com/watch?v=6FAwAXXj5N0)를 보고 실제 성능이 어떻게, 얼마나 차이가 나는지 궁금해짐

- Nginx / Httpd prefork MPM / httpd event MPM 비교

- Nginx
    - 요청을 처리중인 worker의 수 = 요청을 처리중인 process 수 = 요청을 처리중인 thread 수
    - 하나의 요청을 로드밸런싱을 이용해 여러개의 worker process에서 처리할 수 있다

- Nginx (하나의 worker는 N개의 요청이 들어와도 단일 스레드로 처리 / 단일 스레드 + 멀티프로세스를 이용한 Event driven 비동기 처리)
    - 장점
        - 높은 성능: Event driven 비동기 처리 방식으로 고성능 웹서버로 유명함
        - 적은 자원 사용: 단일 스레드 방식으로 동작하여 자원 소비가 적음
        - 높은 안정성: 안정적인 운영 환경을 보장
        - Reverse Proxy 및 Load Balancing 기능 지원: Reverse Proxy 기능을 이용해 요청을 웹 서버 및 애플리케이션 서버로 전달하고, Load Balancing 기능을 이용해 트래픽 분산 처리 가능
    - 단점
        - 미들웨어 지원 부족: Nginx는 다양한 미들웨어를 지원하는 Apache와 비교하면 상대적으로 지원이 부족합니다.
        - Windows 지원: Nginx는 Windows 지원이 상대적으로 부족합니다. 이는 Apache와 비교해 Windows 환경에서의 사용성이 떨어지는 단점으로 작용할 수 있습니다

- httpd Event MPM (httpd 2.4부터 추가된 모드 / 하나의 요청에 다중 스레드 처리)
    - 장점
        - 이벤트 기반 비동기 처리 방식으로 고성능 웹서버로 유명함
        - 다중 스레드 방식으로 동작하여 Prefork MPM과 달리 성능을 높이면서 자원 소비를 줄일 수 있음
        - 정적인 콘텐츠 제공에 최적화되어 있어 단순한 파일 서버로서의 기능을 제공
    - 단점
        - 다중 스레드 방식이기 때문에, 스레드 간 동기화 문제에 대한 대처가 필요함
        - 프로세스가 생성되는 횟수를 최소화하는 Prefork MPM에 비해, Event MPM의 경우 모듈 등과 같은 추가적인 오버헤드가 발생할 수 있음

- httpd Prefork MPM (요청과 스레드의 1:1 매핑)
    - 장점
        - 다중 프로세스 방식으로 동작하여 안정적인 운영 환경을 보장
        - 정적인 콘텐츠 제공에 최적화되어 있어 단순한 파일 서버로서의 기능을 제공
        - 다양한 모듈을 지원하고, 확장성이 높음
    - 단점
        - 다중 프로세스 방식이기 때문에, 많은 자원을 필요로 하며 트래픽이 많을 때 성능이 저하될 수 있음
        - 다중 프로세스 방식이기 때문에 프로세스 간 통신에 대한 오버헤드가 발생할 수 있음

Prefork MPM은 각각의 요청이 별도의 프로세스로 처리됩니다. 따라서 각각의 요청에 대해 별도의 메모리 공간을 할당하게 됩니다. 이는 요청당 메모리 사용량이 높은 경우에는 서버의 부하를 높이게 됩니다. 그러나 프로세스 간의 메모리 공간이 분리되어 있기 때문에 안정성 면에서는 이점이 있습니다

open file limit은 Prefork MPM에서 발생하는 경우가 많습니다. Prefork MPM에서는 하나의 프로세스가 하나의 요청을 처리하기 위해 하나의 스레드를 생성하게 됩니다. 이 때문에 많은 요청이 동시에 발생하면 많은 프로세스와 스레드가 생성되어 open file limit을 초과할 가능성이 있습니다. Event MPM에서는 하나의 프로세스 내에서 여러 개의 요청을 처리하기 때문에 Prefork MPM보다 open file limit의 문제가 적습니다.

httpd event mpm도 비동기 방식으로 요청을 처리하고 이벤트 루프를 사용합니다. 하지만 Nginx와 달리 httpd event mpm은 하나의 프로세스 내에서 여러 개의 스레드가 요청을 처리합니다. 따라서 Nginx와는 약간 다른 방식으로 로드 밸런싱 알고리즘을 사용합니다. 예를 들어 일부 요청은 한 스레드에서 처리되고 다른 요청은 다른 스레드에서 처리됩니다.



(httpd event MPM 모드 + 멀티프로세스 + 단일 스레드)와 Nginx는 모두 이벤트 기반 아키텍처를 사용하고, I/O 멀티플렉싱을 통해 블로킹을 최소화하여 높은 성능을 보입니다. 그러나 구조적으로는 다릅니다.

httpd event MPM 모드 + 멀티프로세스 + 단일 스레드: 이 방식은 멀티 프로세스를 사용하면서 각 프로세스는 하나의 스레드만 처리합니다. 따라서 멀티프로세스로 인한 컨텍스트 스위칭 오버헤드가 있을 수 있지만, 한 스레드 내에서 비동기 I/O를 처리하므로 멀티 스레드보다 안정적입니다.

Nginx: 이 방식은 단일 스레드에서 멀티프로세스를 사용하여 요청을 처리합니다. 각 프로세스는 각자 독립적인 스택, 힙 등의 메모리 공간을 가지며, 프로세스 간에 공유되는 것은 오직 파일 디스크립터와 같은 최소한의 상태 정보만 공유합니다. 이 방식은 멀티 프로세스로 인한 안정성과 분산처리의 이점을 가지지만, IPC를 위한 별도의 메커니즘이 필요하고, 각 프로세스가 독립적으로 동작하기 때문에 일부 작업이 필요할 경우 프로세스 간에 별도의 통신이 필요합니다.

따라서, httpd event MPM 모드 + 멀티프로세스 + 단일 스레드 방식은 안정적이지만 성능은 Nginx에 비해 떨어질 수 있습니다. 반면에, Nginx는 IPC 오버헤드가 없기 때문에 처리 속도가 더 빠를 수 있습니다.





스레드풀의 장점:

각 스레드가 하나의 요청을 처리하기 때문에 멀티코어 CPU에서 병렬 처리가 가능합니다.
스레드간 데이터 공유가 쉽기 때문에, 상태 정보를 유지하거나 공유하는 작업을 처리할 때 유용합니다.
스레드풀의 단점:

스레드 생성과 context switching에 대한 오버헤드가 발생합니다.
각 스레드마다 스택을 할당하기 때문에, 메모리 사용량이 늘어납니다.
스레드간 경쟁 조건이 발생할 수 있으며, 이를 처리하기 위해 복잡한 동기화 기법을 사용해야 합니다.
이벤트 루프의 장점:

비동기 IO를 사용하기 때문에, IO 작업 대기시간이 줄어듭니다.
이벤트 루프는 단일 스레드로 동작하기 때문에, 스레드 생성과 context switching에 대한 오버헤드가 발생하지 않습니다.
상태 정보를 유지하기 위해 별도의 스레드간 동기화가 필요하지 않습니다.
이벤트 루프의 단점:

CPU 바운드 작업의 처리에는 적합하지 않습니다.
이벤트 루프가 처리하는 작업이 무거워지면, 다른 요청들에게 영향을 줄 수 있습니다.




스레드풀

장점: 각 스레드가 독립적으로 작업을 처리할 수 있기 때문에 CPU를 많이 사용하는 작업이나 네트워크 대역폭을 많이 사용하는 작업 등, 오랜 시간 동안 작업을 처리해야 하는 경우에 유리합니다.
단점: 스레드가 많아지면 스레드 간의 컨텍스트 스위칭이 많아지고, 스레드 자체가 차지하는 메모리 공간이 많아지기 때문에, 스레드 개수가 많아지면 일정 수준 이상으로 늘릴 수 없습니다.
이벤트 루프

장점: 이벤트 루프는 하나의 스레드로 여러 개의 이벤트를 처리할 수 있습니다. 즉, 단일 스레드에서 처리할 수 있는 작업들을 비동기적으로 처리할 수 있습니다. 이 때문에 대규모 연결을 처리하거나 높은 트래픽을 처리해야 하는 서버에서 이벤트 루프를 사용하면 많은 자원을 아낄 수 있습니다.
단점: 이벤트 루프는 하나의 이벤트가 처리될 때까지 다른 이벤트를 처리하지 못합니다. 그리고 이벤트 루프 자체는 블로킹되지 않지만, 이벤트 핸들러는 블로킹될 수 있기 때문에, 블로킹을 피하기 위해서는 적절한 콜백 함수를 사용해야 합니다.



nginx는 기본적으로 단일 스레드로 동작합니다. 이는 단일 스레드로 처리하면서도 높은 처리량과 저지연시간을 보장하는 이벤트 기반 아키텍처를 채택하기 때문입니다. 이벤트 기반 아키텍처에서는 하나의 스레드가 여러 개의 커넥션을 처리할 수 있기 때문에, 멀티스레드를 사용하지 않아도 높은 처리량을 달성할 수 있습니다.

또한, 멀티스레드를 사용할 경우에는 동기화 문제와 데드락 등의 문제가 발생할 가능성이 있습니다. 이를 해결하기 위해서는 추가적인 비용이 들어가게 되며, 코드의 복잡도도 증가하게 됩니다. 따라서 nginx는 단일 스레드 방식으로 동작하면서도 높은 처리량과 안정성을 유지하는 것이 장점입니다.

Apache HTTP Server (httpd)는 기본적으로 mod_cgi를 포함하여 동적 콘텐츠 처리를 지원합니다. mod_cgi는 외부 프로그램을 실행하여 동적인 콘텐츠를 생성하고 반환하는 방식으로 동작합니다.

하지만 mod_cgi는 외부 프로그램을 실행할 때마다 매번 새로운 프로세스를 생성하므로, 이로 인해 프로세스 간 통신에 따른 성능 문제가 발생할 수 있습니다. 따라서 Apache HTTP Server에서도 FastCGI 모듈을 사용하여 더 나은 성능을 제공할 수 있습니다.